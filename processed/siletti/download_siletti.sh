#!/bin/bash

ml HDF5/1.12.2-gompi-2022a
ml Python/3.10.4-GCCcore-11.3.0
ml R
# Seurat_4.3.0
# SeuratObject_4.1.3
# Matrix_1.5-3

source /groups/umcg-biogen/tmp01/umcg-mvochteloo/sc_env_3.10.4/bin/activate
# anndata==0.8.0

cd /groups/umcg-biogen/tmp01/input/processeddata/single-cell/Siletti2022_test/ || exit

mkdir raw
# curl -o raw/nonneurons.h5ad https://storage.googleapis.com/linnarsson-lab-human/Nonneurons.h5ad
curl -o raw/nonneurons.h5ad "https://corpora-data-prod.s3.amazonaws.com/f248d156-2a58-4450-af64-80da66b66cb9/local.h5ad?AWSAccessKeyId=ASIATLYQ5N5X3NOFECVA&Signature=WFXmWJhKgapdPzHBYfEKJ7RymnI%3D&x-amz-security-token=IQoJb3JpZ2luX2VjEK3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIH0p5QMl0pUny46qWhNwCEfzkcNl7VPtIsmx90ZQoZ8tAiEAkfw%2F48c6ROnliU2HBpZWUdxkCl9dn6VcRfNI6In2vyIq6wMIdRABGgwyMzE0MjY4NDY1NzUiDKhLsVHcAfhchvrjLCrIA2xSiS3lr70MwEqYWwrAqdRLJoaxde6cva%2Bdt6CJzpbZmnOq%2BYPD%2BX6paqxt8PCnIJhn216%2FPPDqbUGKr25f7bQDhi9uuYCVb5OYiJNFsh0fN9X3NwqHYqvk%2BAX3r3vqmB7CWxLUWyEZ6De4oeDlqVtM8xCNvumejdoFp2JmhO1dMR591BgH%2B42beQEh606bdTCU44Kh2TF6DxBUZcPD777GZWoZwq%2Bkh6Z7uqZYgMR0s8Lkv%2FpP%2BPVxBx7jhHTa0MPJ4OHoeK8LUXEQ9z52v9L%2BC%2Fr0XQva5lBbys%2BhtdkjQUXAkm3YONKjXjEbgDzsYWNMWj1%2FMNA1Peq36Jakigh8grd%2FngR1lUnwZqwgc3utpUJNWkKz6BDaKV3PAUs5z4o8N%2FMriM%2B70%2Fgj3YaRELLoY7V7MoqPAQKo6kePcSBCfsGjbf7OVIuWBtgkMThyNyWrYu4Hp2gSfkkUYU5ORMKU0SBsxJgzFY8zXo2Ow4vtwoNSmtkQaA6m4zqzax9RcJRvsUPSv3IgrV8sFZCkI8joWbTOShdJ1fuDZJW0u3V%2B77gmrFJhHtHuaT6O9WJrrcrxR1dmlyOhZkXQsjzeYhGu0WJVrT2GAjCNnuGgBjqlAZvDNjQ4165XfQfWieYmb7ceuv2q6dGvXjkl%2FJvXv53nmaGAHXOKRpIiwhF7LQI6FsjWAMDZlSeIem91m4hlxmr6hnlR%2FjtYDNbEOv8NM2MnnZJp2MWHnovESUNIIFN4ah5POj3Oh2XeNKwzKMc1JHSzDOrExplUwmfk38fAXYSyRCnCRjGtucR%2FUp00PQ%2FomZLrdHzUyFbiiIdEf%2FSmfM7MlNDITg%3D%3D&Expires=1679926156"
# curl -o raw/neurons.h5ad https://storage.googleapis.com/linnarsson-lab-human/Neurons.h5ad
curl -o raw/neurons.h5ad "https://corpora-data-prod.s3.amazonaws.com/3693a7ec-18d8-40ad-a434-4d9c68921e99/local.h5ad?AWSAccessKeyId=ASIATLYQ5N5X3NOFECVA&Signature=BoptaRhEhdkQa20JaeUJYnI%2FFBY%3D&x-amz-security-token=IQoJb3JpZ2luX2VjEK3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIH0p5QMl0pUny46qWhNwCEfzkcNl7VPtIsmx90ZQoZ8tAiEAkfw%2F48c6ROnliU2HBpZWUdxkCl9dn6VcRfNI6In2vyIq6wMIdRABGgwyMzE0MjY4NDY1NzUiDKhLsVHcAfhchvrjLCrIA2xSiS3lr70MwEqYWwrAqdRLJoaxde6cva%2Bdt6CJzpbZmnOq%2BYPD%2BX6paqxt8PCnIJhn216%2FPPDqbUGKr25f7bQDhi9uuYCVb5OYiJNFsh0fN9X3NwqHYqvk%2BAX3r3vqmB7CWxLUWyEZ6De4oeDlqVtM8xCNvumejdoFp2JmhO1dMR591BgH%2B42beQEh606bdTCU44Kh2TF6DxBUZcPD777GZWoZwq%2Bkh6Z7uqZYgMR0s8Lkv%2FpP%2BPVxBx7jhHTa0MPJ4OHoeK8LUXEQ9z52v9L%2BC%2Fr0XQva5lBbys%2BhtdkjQUXAkm3YONKjXjEbgDzsYWNMWj1%2FMNA1Peq36Jakigh8grd%2FngR1lUnwZqwgc3utpUJNWkKz6BDaKV3PAUs5z4o8N%2FMriM%2B70%2Fgj3YaRELLoY7V7MoqPAQKo6kePcSBCfsGjbf7OVIuWBtgkMThyNyWrYu4Hp2gSfkkUYU5ORMKU0SBsxJgzFY8zXo2Ow4vtwoNSmtkQaA6m4zqzax9RcJRvsUPSv3IgrV8sFZCkI8joWbTOShdJ1fuDZJW0u3V%2B77gmrFJhHtHuaT6O9WJrrcrxR1dmlyOhZkXQsjzeYhGu0WJVrT2GAjCNnuGgBjqlAZvDNjQ4165XfQfWieYmb7ceuv2q6dGvXjkl%2FJvXv53nmaGAHXOKRpIiwhF7LQI6FsjWAMDZlSeIem91m4hlxmr6hnlR%2FjtYDNbEOv8NM2MnnZJp2MWHnovESUNIIFN4ah5POj3Oh2XeNKwzKMc1JHSzDOrExplUwmfk38fAXYSyRCnCRjGtucR%2FUp00PQ%2FomZLrdHzUyFbiiIdEf%2FSmfM7MlNDITg%3D%3D&Expires=1679926176"

mkdir -p cellranger/nonneurons
python3 export_h5ad_to_cellranger.py raw/nonneurons.h5ad cellranger/nonneurons
gzip cellranger/nonneurons/matrix.mtx

mkdir -p cellranger/neurons
python3 export_h5ad_to_cellranger.py raw/neurons.h5ad cellranger/neurons
gzip cellranger/neurons/matrix.mtx

mkdir -p seurat/nonneurons
Rscript cellranger_to_seurat.R cellranger/nonneurons seurat/nonneurons

mkdir -p seurat/neurons
Rscript cellranger_to_seurat.R cellranger/neurons seurat/neurons

Rscript combine_siletti_reference.R seurat



